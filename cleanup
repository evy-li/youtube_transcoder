#!/usr/bin/env bash
# remove leftovers

set -euo pipefail

# FIFO pattern used by run
PREVIEW_GLOB='/tmp/ytt_preview_fifo.*'

# use nullglob temporarily so unmatched globs expand to nothing (bash-only)
shopt -s nullglob 2>/dev/null || true
matches=( $PREVIEW_GLOB )
shopt -u nullglob 2>/dev/null || true

if [[ ${#matches[@]} -eq 0 ]]; then
  echo "No preview FIFO files found matching $PREVIEW_GLOB"
else
  echo "Removing ${#matches[@]} preview FIFO file(s):"
  for f in "${matches[@]}"; do
    rm -f -- "$f" && echo "  removed $f"
  done
fi

echo
echo "Killing ffplay processes (if any)..."
if command -v pkill >/dev/null 2>&1; then
  pkill ffplay && echo "pkill sent to ffplay processes" || true
else
  pids=($(ps aux | awk '/[f]fplay/ {print $2}'))
  if [[ ${#pids[@]} -gt 0 ]]; then
    for pid in "${pids[@]}"; do
      kill "$pid" && echo "killed $pid" || true
    done
  fi
fi

exit 0